C51 COMPILER V9.60.0.0   MCU_HAND_UART                                                     07/06/2020 14:09:33 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MCU_HAND_UART
OBJECT MODULE PLACED IN .\Objects\MCU_Hand_Uart.obj
COMPILER INVOKED BY: D:\Keil5\C51\BIN\C51.EXE MCU_Hand_Uart.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\
                    -Listings\MCU_Hand_Uart.lst) TABS(2) OBJECT(.\Objects\MCU_Hand_Uart.obj)

line level    source

   1          #include "MCU_Hand_Uart.h"
   2          
   3          //数据包序号
   4          unsigned char Sn=0x00;
   5          
   6          
   7          //========================================================================
   8          // 函数: void UART_Receive_Processing()
   9          // 描述: UART1接收处理函数
  10          // 参数: 无
  11          // 返回: 无
  12          // 版本: V1.0, 2020.04.24
  13          //========================================================================
  14          void UART_Receive_Processing()
  15          {
  16   1        //判断是否是有效的处理命令标记位
  17   1        unsigned char Uart_Receive_flag=0;
  18   1        //校验接收数据，UART2打印接收数据
  19   1        Uart_Receive_flag=Uart_Pretreatment();
  20   1        if(Uart_Receive_flag)
  21   1        {
  22   2          //无线模块连接标记位
  23   2          Wifi_flag=0x01;
  24   2          //获取包序号并赋值给Sn
  25   2          Sn=RX1_Buffer[5];
  26   2          switch(RX1_Buffer[4])
  27   2          {
  28   3            //WiFi模组获取设备信息
  29   3            case 0x01:
  30   3              Data_Encapsulation(Device_information,sizeof(Device_information),0x00,Sn,0x00);
  31   3              break;
  32   3            //WiFi模组控制设备,读取设备的当前状态
  33   3            case 0x03:
  34   3              //WiFi模 组 控 制 设 备
  35   3              if(RX1_Buffer[8]==0x01)
  36   3              {
  37   4                //收到数据后，mcu控制设备函数
  38   4                MCU_Application_Control(RX1_Buffer);          
  39   4                Data_Encapsulation(Mcu_send,9,0x04,Sn,0x00);
  40   4                //MCU主动上报当前状态
  41   4                Sn=Sn+0x01;
  42   4                Data_Encapsulation(Mcu_send,14,0x05,Sn,0x04);
  43   4                MCU_OLED_StatusChange(RX1_Buffer[9]);
  44   4              }
  45   3              // WiFi模 组 读 取 设 备 的 当 前 状 态
  46   3              if(RX1_Buffer[8]==0x02){Data_Encapsulation(Mcu_send,14,0x04,Sn,0x03);}
  47   3              break;  
  48   3            //MCU主动上报当前状态WIFI模组回复
  49   3            case 0x06:  
  50   3              break;
  51   3            //WiFi模组向MCU发送心跳
  52   3            case 0x07:
  53   3                //关闭定时器，将计数器置0
  54   3                TR0=0;Timer0_Count=0;
C51 COMPILER V9.60.0.0   MCU_HAND_UART                                                     07/06/2020 14:09:33 PAGE 2   

  55   3                Data_Encapsulation(Mcu_send,9,0x08,Sn,0x00);
  56   3                //打开定时器
  57   3                TR0=1;
  58   3            break;  
  59   3            //通知WIFI模组进入配置模式后接收WIFI模组回复
  60   3            case 0x0a:
  61   3              //OLED_CLS_Local(0,2,X_WIDTH,Y_WIDTH);
  62   3              //OLED_P6x8Str(2,2,"Enter Wifi Config!");
  63   3              break;
  64   3            //重置WiFi模组后接收WIFI模组回复
  65   3            case 0x0c:
  66   3              //OLED_CLS_Local(0,2,X_WIDTH,Y_WIDTH);
  67   3              //OLED_P6x8Str(2,2,"Wifi Reset Success!");
  68   3              break;
  69   3            //WiFi模组向MCU推送WiFi状态
  70   3            case 0x0d:
  71   3                //将手机连接标志位，网络连接标志位初始化
  72   3                Phone_flag=0;Net_flag=0;
  73   3                //展示WiFi连接信息
  74   3                MCU_OLED_MessageShow(RX1_Buffer[4],RX1_Buffer[8],RX1_Buffer[9]);
  75   3                if(RX1_Buffer[8]>=0x00 && RX1_Buffer[8]<=0x07 ){Net_flag=1;}
  76   3                if(RX1_Buffer[8]>=0x08 && RX1_Buffer[8]<=0x0F ){Net_flag=1;Phone_flag=1;}
  77   3                //展示产品连接信息
  78   3                MCU_OLED_StatusChange(0x00);
  79   3                Data_Encapsulation(Mcu_send,9,0x0e,Sn,0x00);
  80   3              break;
  81   3            case 0x0f:
  82   3              Data_Encapsulation(Mcu_send,9,0x10,Sn,0x00);
  83   3              break;
  84   3            //WiFi模组非法数据包通知
  85   3            case 0x11:
  86   3              Data_Encapsulation(Mcu_send,10,0x12,Sn,RX1_Buffer[8]);
  87   3              break;      
  88   3            //MCU请求WiFi进入可绑定模式，WiFi模组回复 
  89   3            case 0x16:
  90   3              break;    
  91   3            //MCU请求获取网络时间，WiFi模组回复 
  92   3            case 0x18:
  93   3              break;
  94   3            case 0x2a:
  95   3              //MCU请求WiFi重启，WiFi模组回复
  96   3              break;
  97   3            }
  98   2            RST_Uart_Timer();
  99   2        } 
 100   1      }
 101          //========================================================================
 102          // 函数: void UART_Send_Processing()
 103          // 描述: UART1发送处理函数
 104          // 参数: 无
 105          // 返回: 无
 106          // 版本: V1.0, 2020.04.24
 107          //========================================================================
 108          void UART_Send_Processing()
 109          {
 110   1        
 111   1        unsigned char flag=0;
 112   1        //  配置WiFi模式(Soft模式)  **/
 113   1        if(Set_soft_flag==0)      {Delay_ms(10);  if(Set_soft_flag==0)      {flag=0x01;} }
 114   1        //  配置WiFi模式(AP模式)  **/
 115   1        if(Set_AP_flag==0)        {Delay_ms(10);  if(Set_AP_flag==0)        {flag=0x02;} }
 116   1        //  重置WiFi信息  **/
C51 COMPILER V9.60.0.0   MCU_HAND_UART                                                     07/06/2020 14:09:33 PAGE 3   

 117   1        if(Reset_message_flag==0) {Delay_ms(10);  if(Reset_message_flag==0) {flag=0x03;} }
 118   1        //  WiFi进入可绑定模式  **/
 119   1        if(Bindable_wifi_flag==0) {Delay_ms(10);  if(Bindable_wifi_flag==0) {flag=0x04;} }
 120   1        //   重启WiFi模组   **/
 121   1        if(Restart_wifi_flag==0)  {Delay_ms(10);  if(Restart_wifi_flag==0)  {flag=0x05;} }
 122   1        if(flag!=0&&Wifi_flag==1)
 123   1        {
 124   2          if(flag<=0x05){OLED_CLS_Local(0,2,X_WIDTH,Y_WIDTH);}
 125   2          Sn=Sn+0x01;
 126   2          switch(flag)
 127   2          {
 128   3            //  配置WiFi模式(Soft模式)  **/
 129   3            case 0x01:
 130   3                OLED_P6x8Str(2,2,"Configure Wifi:Soft");
 131   3                Data_Encapsulation(Mcu_send,10,0x09,Sn,0x01);
 132   3              break;
 133   3            //  配置WiFi模式(AP模式)  **/
 134   3            case 0x02:
 135   3                OLED_P6x8Str(2,2,"Configure Wifi:AP");
 136   3                Data_Encapsulation(Mcu_send,10,0x09,Sn,0x02);
 137   3              break;
 138   3            //  重置WiFi信息  **/
 139   3            case 0x03:
 140   3                OLED_P6x8Str(2,2,"Reset Wifi!");
 141   3                Data_Encapsulation(Mcu_send,9,0x0b,Sn,0x00);
 142   3              break;
 143   3            //  WiFi进入可绑定模式  **/
 144   3            case 0x04:
 145   3                OLED_P6x8Str(2,2,"Enter bindable mode!");
 146   3                Data_Encapsulation(Mcu_send,9,0x15,Sn,0x00);
 147   3              break;
 148   3            //   重启WiFi模组   **/
 149   3            case 0x05:
 150   3                OLED_P6x8Str(2,2,"Restart Wifi!");
 151   3                Data_Encapsulation(Mcu_send,9,0x29,Sn,0x00);
 152   3              break;
 153   3          }
 154   2          while(Set_soft_flag==0||Set_AP_flag==0||Reset_message_flag==0||Bindable_wifi_flag==0||Restart_wifi_flag=
             -=0);
 155   2        }
 156   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    972    ----
   CONSTANT SIZE    =     85    ----
   XDATA SIZE       =      1       1
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
